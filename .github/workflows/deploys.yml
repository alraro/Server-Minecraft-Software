# Nombre del workflow
name: Deploy to OCI VM (Smart)

# 1. Se activa en CADA 'push' a la rama 'main'
on:
  push:
    branches:
      - main
    # ¡HEMOS QUITADO el filtro 'paths:' para que siempre se ejecute!

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Paso 1: Clonar el código EN EL RUNNER DE GITHUB
      # (Esto es necesario para que el 'Paso 2' pueda ver el historial)
      - name: 1. Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necesario para que la acción de abajo pueda ver el historial

      # Paso 2: Detectar si los archivos de 'my-packwiz' cambiaron
      # (Esto se ejecuta EN EL RUNNER DE GITHUB)
      - name: 2. Detect changes in modpack
        id: changed_files_packwiz
        uses: tj-actions/changed-files@v44
        with:
          # La carpeta que nos importa
          files: my-packwiz/**

      # Paso 3: SCRIPT COMPLETO (si 'my-packwiz' CAMBIÓ)
      - name: 3. Pull and Restart Server (if packwiz changed)
        # Este 'if:' comprueba la salida del 'Paso 2'
        if: steps.changed_files_packwiz.outputs.any_changed == 'true'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Detectado cambio en 'my-packwiz'. Ejecutando reinicio completo..."
            cd /home/ubuntu/Server-Minecraft-Software

            echo "Haciendo git pull..."
            git pull origin main

            echo "Deteniendo servidor..."
            ./scripts/stop_server.sh

            echo "Borrando mods antiguos..."
            sudo rm -r minecraft-data/mods/

            echo "Iniciando servidor..."
            ./scripts/start_server.sh

            echo "¡Proceso de reinicio completado!"

      # Paso 4: SCRIPT SIMPLE (si 'my-packwiz' NO CAMBIÓ)
      - name: 4. Pull Only (if packwiz did NOT change)
        # Este 'if:' es la condición opuesta al 'Paso 3'
        if: steps.changed_files_packwiz.outputs.any_changed == 'false'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "No se detectaron cambios en 'my-packwiz'. Solo haciendo git pull..."
            cd /home/ubuntu/Server-Minecraft-Software

            echo "Haciendo git pull..."
            git pull origin main

            echo "¡Proceso completado! No se necesita reinicio."
